# API 스펙

## 개요

이 문서는 forps 백엔드 API의 전체 엔드포인트, 요청/응답 형식을 정의한다.

- Base URL: `/api/v1`
- 인증: Bearer Token (JWT)
- 응답 형식: JSON

## 설계 결정

| 항목 | 결정 |
|------|------|
| URL 구조 | 중첩 리소스 (RESTful) |
| Tasks API | `/projects/{project_id}/tasks`로 리팩토링 |

---

## 1. Auth API

인증 관련 엔드포인트. 모든 응답은 표준 형식을 따른다.

### Endpoints

| Method | Path | 설명 | 인증 |
|--------|------|------|------|
| POST | `/auth/register` | 회원가입 | X |
| POST | `/auth/login` | 로그인 | X |
| GET | `/auth/me` | 현재 사용자 정보 | O |
| POST | `/auth/logout` | 로그아웃 (선택, 현재 미구현) | O |

### POST /auth/register

**Request**
```json
{
  "email": "user@example.com",
  "name": "홍길동",
  "password": "securepassword123"
}
```

**Response 201**
```json
{
  "token": {
    "access_token": "eyJ...",
    "token_type": "bearer"
  },
  "user": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "email": "user@example.com",
    "name": "홍길동",
    "created_at": "2026-02-04T10:00:00Z"
  }
}
```

**Errors**
- `409 AUTH_EMAIL_EXISTS`: 이메일 중복

### POST /auth/login

**Request**
```json
{
  "email": "user@example.com",
  "password": "securepassword123"
}
```

**Response 200**
```json
{
  "token": {
    "access_token": "eyJ...",
    "token_type": "bearer"
  },
  "user": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "email": "user@example.com",
    "name": "홍길동",
    "created_at": "2026-02-04T10:00:00Z"
  }
}
```

**Errors**
- `401 AUTH_INVALID_CREDENTIALS`: 이메일/비밀번호 불일치

### GET /auth/me

**Headers**
```
Authorization: Bearer {access_token}
```

**Response 200**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "email": "user@example.com",
  "name": "홍길동",
  "created_at": "2026-02-04T10:00:00Z"
}
```

**Errors**
- `401 AUTH_TOKEN_EXPIRED`: 토큰 만료

---

## 2. Workspace API

워크스페이스 관리. 모든 엔드포인트는 인증 필요.

### Endpoints

| Method | Path | 설명 | 권한 |
|--------|------|------|------|
| GET | `/workspaces` | 내 워크스페이스 목록 | member |
| POST | `/workspaces` | 워크스페이스 생성 | - |
| GET | `/workspaces/{workspace_id}` | 워크스페이스 상세 | member |
| PATCH | `/workspaces/{workspace_id}` | 워크스페이스 수정 | owner |
| DELETE | `/workspaces/{workspace_id}` | 워크스페이스 삭제 | owner |
| GET | `/workspaces/{workspace_id}/members` | 멤버 목록 | member |
| POST | `/workspaces/{workspace_id}/members` | 멤버 초대 | owner |
| PATCH | `/workspaces/{workspace_id}/members/{user_id}` | 역할 변경 | owner |
| DELETE | `/workspaces/{workspace_id}/members/{user_id}` | 멤버 제거 | owner |

### GET /workspaces

현재 사용자가 멤버로 속한 워크스페이스 목록.

**Response 200**
```json
[
  {
    "id": "ws-uuid-1",
    "name": "팀 워크스페이스",
    "slug": "team-ws",
    "description": "우리 팀의 워크스페이스",
    "my_role": "owner",
    "member_count": 3,
    "created_at": "2026-01-15T09:00:00Z",
    "updated_at": "2026-02-01T14:30:00Z"
  }
]
```

### POST /workspaces

**Request**
```json
{
  "name": "새 워크스페이스",
  "slug": "new-ws",
  "description": "설명 (옵션)"
}
```

**Response 201**
```json
{
  "id": "ws-uuid-new",
  "name": "새 워크스페이스",
  "slug": "new-ws",
  "description": "설명 (옵션)",
  "my_role": "owner",
  "member_count": 1,
  "created_at": "2026-02-04T10:00:00Z",
  "updated_at": "2026-02-04T10:00:00Z"
}
```

**Errors**
- `409 SLUG_EXISTS`: slug 중복

### POST /workspaces/{workspace_id}/members

멤버 초대 (이메일로).

**Request**
```json
{
  "email": "newmember@example.com",
  "role": "editor"
}
```

**Response 201**
```json
{
  "id": "member-uuid",
  "user_id": "user-uuid",
  "role": "editor",
  "created_at": "2026-02-04T10:00:00Z",
  "user": {
    "id": "user-uuid",
    "name": "새멤버",
    "email": "newmember@example.com"
  }
}
```

**Errors**
- `404 USER_NOT_FOUND`: 해당 이메일의 사용자 없음
- `409 ALREADY_MEMBER`: 이미 멤버임
- `403 PERMISSION_DENIED`: owner 권한 없음

---

## 3. Project API

프로젝트 관리. 워크스페이스 하위 리소스.

### Endpoints

| Method | Path | 설명 | 권한 |
|--------|------|------|------|
| GET | `/workspaces/{workspace_id}/projects` | 프로젝트 목록 | member |
| POST | `/workspaces/{workspace_id}/projects` | 프로젝트 생성 | editor+ |
| GET | `/workspaces/{workspace_id}/projects/{project_id}` | 프로젝트 상세 | member |
| PATCH | `/workspaces/{workspace_id}/projects/{project_id}` | 프로젝트 수정 | editor+ |
| DELETE | `/workspaces/{workspace_id}/projects/{project_id}` | 프로젝트 삭제 | owner |
| GET | `/projects/{project_id}/members` | 프로젝트 멤버 목록 | member |
| POST | `/projects/{project_id}/members` | 프로젝트 멤버 추가 | owner |
| PATCH | `/projects/{project_id}/members/{user_id}` | 역할 변경 | owner |
| DELETE | `/projects/{project_id}/members/{user_id}` | 멤버 제거 | owner |

### GET /workspaces/{workspace_id}/projects

**Response 200**
```json
[
  {
    "id": "proj-uuid-1",
    "workspace_id": "ws-uuid-1",
    "name": "프로젝트 A",
    "description": "메인 프로젝트",
    "my_role": "editor",
    "task_count": 12,
    "created_at": "2026-01-20T09:00:00Z",
    "updated_at": "2026-02-03T16:00:00Z"
  }
]
```

### POST /workspaces/{workspace_id}/projects

**Request**
```json
{
  "name": "새 프로젝트",
  "description": "프로젝트 설명"
}
```

**Response 201**
```json
{
  "id": "proj-uuid-new",
  "workspace_id": "ws-uuid-1",
  "name": "새 프로젝트",
  "description": "프로젝트 설명",
  "my_role": "owner",
  "task_count": 0,
  "created_at": "2026-02-04T10:00:00Z",
  "updated_at": "2026-02-04T10:00:00Z"
}
```

---

## 4. Task API

태스크 관리. 프로젝트 하위 리소스.

### Endpoints

| Method | Path | 설명 | 권한 |
|--------|------|------|------|
| GET | `/projects/{project_id}/tasks` | 태스크 목록 | viewer+ |
| POST | `/projects/{project_id}/tasks` | 태스크 생성 | editor+ |
| GET | `/tasks/{task_id}` | 태스크 상세 | viewer+ |
| PUT | `/tasks/{task_id}` | 태스크 수정 | editor+ |
| DELETE | `/tasks/{task_id}` | 태스크 삭제 | owner |
| GET | `/tasks/week` | 주간 태스크 (내 것) | - |

### GET /projects/{project_id}/tasks

프로젝트의 태스크 목록 (Board 렌더링용).

**Query Parameters**

| Param | Type | 설명 |
|-------|------|------|
| `status` | string | todo, doing, done, blocked |
| `assignee_id` | uuid | 특정 담당자 필터 |
| `mine_only` | boolean | true면 내 태스크만 |

**Response 200**
```json
[
  {
    "id": "task-uuid-1",
    "project_id": "proj-uuid-1",
    "title": "로그인 페이지 구현",
    "description": "소셜 로그인 포함",
    "status": "doing",
    "due_date": "2026-02-10T00:00:00Z",
    "assignee_id": "user-uuid-1",
    "reporter_id": "user-uuid-2",
    "created_at": "2026-02-01T09:00:00Z",
    "updated_at": "2026-02-03T14:00:00Z",
    "assignee": {
      "id": "user-uuid-1",
      "name": "홍길동",
      "email": "hong@example.com"
    },
    "reporter": {
      "id": "user-uuid-2",
      "name": "김철수",
      "email": "kim@example.com"
    }
  }
]
```

### POST /projects/{project_id}/tasks

**Request**
```json
{
  "title": "새 태스크",
  "description": "태스크 설명",
  "status": "todo",
  "due_date": "2026-02-15T00:00:00Z",
  "assignee_id": "user-uuid-1"
}
```

- `status`: 기본값 `todo`
- `assignee_id`: 기본값 = 생성자 (current_user)

**Response 201**
```json
{
  "id": "task-uuid-new",
  "project_id": "proj-uuid-1",
  "title": "새 태스크",
  "description": "태스크 설명",
  "status": "todo",
  "due_date": "2026-02-15T00:00:00Z",
  "assignee_id": "user-uuid-1",
  "reporter_id": "current-user-uuid",
  "created_at": "2026-02-04T10:00:00Z",
  "updated_at": "2026-02-04T10:00:00Z",
  "assignee": { ... },
  "reporter": { ... }
}
```

### PUT /tasks/{task_id}

현재 구현은 `PUT` 메서드를 사용하지만, 동작은 부분 업데이트(변경 필드만 전송) 방식이다.

**Request**
```json
{
  "status": "done"
}
```

**Response 200**
```json
{
  "id": "task-uuid-1",
  "project_id": "proj-uuid-1",
  "title": "로그인 페이지 구현",
  "status": "done",
  ...
}
```

**Errors**
- `403 PERMISSION_DENIED`: viewer는 수정 불가
- `404 RESOURCE_NOT_FOUND`: 태스크 없음

### GET /tasks/week

현재 사용자의 주간 태스크 조회.

**Query Parameters**

| Param | Type | 필수 | 설명 |
|-------|------|------|------|
| `week_start` | date | O | 주 시작일 (월요일, YYYY-MM-DD) |

**Response 200**
```json
[
  {
    "id": "task-uuid-1",
    "project_id": "proj-uuid-1",
    "title": "...",
    "status": "doing",
    "due_date": "2026-02-07T00:00:00Z",
    ...
  }
]
```

---

## 5. ShareLink API

공유 링크 관리 및 공개 접근.

### Endpoints

| Method | Path | 설명 | 인증 | 권한 |
|--------|------|------|------|------|
| GET | `/projects/{project_id}/share-links` | 공유 링크 목록 | O | owner |
| POST | `/projects/{project_id}/share-links` | 공유 링크 생성 | O | owner |
| DELETE | `/share-links/{link_id}` | 공유 링크 철회 | O | owner |
| GET | `/share/{token}` | 공유 보드 조회 | X | - |

### POST /projects/{project_id}/share-links

**Request**
```json
{
  "expires_at": "2026-03-01T00:00:00Z"
}
```

- `expires_at`: 옵션. null이면 무기한.

**Response 201**
```json
{
  "id": "link-uuid",
  "project_id": "proj-uuid-1",
  "token": "abc123xyz789",
  "scope": "project_read",
  "is_active": true,
  "expires_at": "2026-03-01T00:00:00Z",
  "created_by": "user-uuid-1",
  "created_at": "2026-02-04T10:00:00Z",
  "share_url": "https://app.example.com/share/abc123xyz789"
}
```

### DELETE /share-links/{link_id}

공유 링크 철회 (비활성화).

**Response 204** (No Content)

### GET /share/{token}

비인증 공개 접근. 프로젝트 보드를 read-only로 조회.

**Response 200**
```json
{
  "project": {
    "id": "proj-uuid-1",
    "name": "프로젝트 A",
    "description": "메인 프로젝트"
  },
  "tasks": [
    {
      "id": "task-uuid-1",
      "title": "로그인 페이지 구현",
      "status": "doing",
      "due_date": "2026-02-10T00:00:00Z",
      "assignee": {
        "name": "홍길동"
      },
      "created_at": "2026-02-01T09:00:00Z",
      "updated_at": "2026-02-03T14:00:00Z"
    }
  ],
  "last_updated_at": "2026-02-03T16:00:00Z"
}
```

**참고**: 공개 응답에서는 프라이버시를 위해 `email` 필드 제외.

**Errors**
- `404`: 유효하지 않거나 만료된 토큰

---

## 6. 표준 에러 응답

### HTTP 상태 코드

| 코드 | 의미 | 사용 상황 |
|------|------|----------|
| 200 | OK | 조회/수정 성공 |
| 201 | Created | 생성 성공 |
| 204 | No Content | 삭제 성공 |
| 400 | Bad Request | 유효성 검증 실패 |
| 401 | Unauthorized | 인증 필요 / 토큰 만료 |
| 403 | Forbidden | 권한 없음 |
| 404 | Not Found | 리소스 없음 |
| 409 | Conflict | 중복 |
| 422 | Unprocessable Entity | Pydantic 검증 실패 |
| 500 | Internal Server Error | 서버 오류 |

### 에러 응답 형식

```json
{
  "detail": "사용자에게 보여줄 메시지",
  "code": "ERROR_CODE",
  "field": "email"
}
```

- `detail`: 사람이 읽을 수 있는 메시지
- `code`: 프로그래매틱 처리용 상수
- `field`: 필드 오류 시 해당 필드명 (옵션)

### 에러 코드 목록

| 코드 | HTTP | 설명 |
|------|------|------|
| `AUTH_INVALID_CREDENTIALS` | 401 | 이메일/비밀번호 불일치 |
| `AUTH_TOKEN_EXPIRED` | 401 | 토큰 만료 |
| `AUTH_TOKEN_INVALID` | 401 | 유효하지 않은 토큰 |
| `AUTH_EMAIL_EXISTS` | 409 | 이메일 중복 |
| `PERMISSION_DENIED` | 403 | 권한 부족 |
| `RESOURCE_NOT_FOUND` | 404 | 리소스 없음 |
| `VALIDATION_ERROR` | 400 | 필드 유효성 실패 |
| `SLUG_EXISTS` | 409 | slug 중복 |
| `ALREADY_MEMBER` | 409 | 이미 멤버임 |
| `USER_NOT_FOUND` | 404 | 사용자 없음 |
| `SHARE_LINK_EXPIRED` | 404 | 공유 링크 만료 |

---

## 권한 요약

| 역할 | 조회 | 생성 | 수정 | 삭제 | 멤버관리 | 공유링크 |
|------|------|------|------|------|----------|----------|
| owner | O | O | O | O | O | O |
| editor | O | O | O | X | X | X |
| viewer | O | X | X | X | X | X |

---

## 리팩토링 반영 항목

기존 Tasks API 리팩토링 반영 완료:
- `POST /tasks/{project_id}` → `POST /projects/{project_id}/tasks`
- 프론트엔드 호출 경로 수정 완료

---

## 관련 문서

- `docs/plans/2026-02-04-data-model-design.md`: 데이터 모델
- `PRD.md`: 제품 요구사항
- `BACKLOG.md`: 구현 백로그
